<div th:fragment="fragment"
     xmlns:th="http://www.thymeleaf.org"
     th:with="
        cmd=${command},
        whId=${command != null && command.id != null ? command.id : 0},
        avail=${availableEmployees},
        assignedIds=${assignedEmployeeIds}
     ">

    <div class="wh-sections">

        <section class="card">
            <header class="card-h">
                <div style="display:flex;flex-direction:column;gap:4px;min-width:0">
                    <h2 th:text="${cmd != null && cmd.code != null ? 'Magazyn: ' + cmd.code : 'Edycja magazynu'}">
                        Edycja magazynu
                    </h2>
                    <div style="color:rgba(255,255,255,0.65);font-size:.92rem">Tryb: edycja</div>
                </div>

                <div class="card-actions">
                    <a class="chip" th:href="@{/Warehouses/GetWarehouses}">Wr√≥ƒá</a>
                </div>
            </header>

            <div class="card-b">

                <div class="alert-glass alert-glass--success" th:if="${success != null}">
                    <div class="alert-glass__icon">‚úì</div>
                    <div class="alert-glass__content">
                        <div class="alert-glass__title">Sukces</div>
                        <div class="alert-glass__msg" th:text="${success}">Zapisano zmiany.</div>
                    </div>
                </div>

                <div class="alert-glass alert-glass--danger" th:if="${error != null}">
                    <div class="alert-glass__icon">!</div>
                    <div class="alert-glass__content">
                        <div class="alert-glass__title">Nie uda≈Ço siƒô wykonaƒá operacji</div>
                        <div class="alert-glass__msg" th:text="${error}">WystƒÖpi≈Ç b≈ÇƒÖd podczas zapisu.</div>
                    </div>
                </div>

                <form th:object="${command}"
                      th:action="@{/Warehouses/EditWarehouse}"
                      method="post"
                      style="display:grid;gap:14px"
                      onsubmit="return lockSubmit(this)">

                    <input type="hidden" th:field="*{id}"/>

                    <div class="grid-2" style="min-width:0">
                        <div style="min-width:0">
                            <label class="form-label">Kod</label>
                            <input class="form-input mono" th:field="*{code}" placeholder="np. MAG-01" required/>
                            <div class="form-err" th:if="${#fields.hasErrors('code')}" th:errors="*{code}"></div>
                        </div>

                        <div style="min-width:0">
                            <label class="form-label">Nazwa</label>
                            <input class="form-input" th:field="*{name}" placeholder="np. Magazyn centralny" required/>
                            <div class="form-err" th:if="${#fields.hasErrors('name')}" th:errors="*{name}"></div>
                        </div>

                        <div style="grid-column:1 / -1;min-width:0">
                            <label class="form-label">Opis (opcjonalnie)</label>
                            <textarea class="form-input"
                                      th:field="*{description}"
                                      style="min-height:120px;resize:vertical"
                                      placeholder="Kr√≥tki opis magazynu..."></textarea>
                            <div class="form-err" th:if="${#fields.hasErrors('description')}" th:errors="*{description}"></div>
                        </div>
                    </div>

                    <div class="form-actions" style="display:flex;gap:10px;flex-wrap:wrap;justify-content:space-between">
                        <a class="chip chip--danger"
                           th:if="${cmd != null && cmd.id != null}"
                           th:href="@{/Warehouses/DeleteWarehouse(id=${cmd.id})}"
                           onclick="return confirm('Na pewno usunƒÖƒá magazyn?')">
                            üóë Usu≈Ñ
                        </a>

                        <button class="chip chip--save" type="submit">üíæ Zapisz zmiany</button>
                    </div>

                </form>
            </div>
        </section>

        <section class="card address-panel address-panel--strong">
            <header class="card-h">
                <div style="display:flex;flex-direction:column;gap:4px;min-width:0">
                    <h2 style="font-size:1.05rem">Adres magazynu</h2>
                    <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
                        <span class="badge">Tylko podglƒÖd</span>
                        <div style="color:rgba(255,255,255,0.80);font-size:.90rem">
                            To jest adres przypisany do magazynu.
                        </div>
                    </div>
                </div>
            </header>

            <div class="card-b" style="display:grid;gap:12px;min-width:0">

                <div class="placeholder" th:if="${address == null}">
                    <div class="ph-title">Brak adresu</div>
                    <div class="ph-sub">Ten magazyn nie ma przypisanego adresu.</div>
                </div>

                <div th:if="${address != null}" class="addr-grid" style="min-width:0;display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:12px">
                    <div class="addr-field">
                        <label class="form-label">Ulica</label>
                        <input class="form-input form-input--ro" th:value="${address.street != null ? address.street : '‚Äî'}" readonly/>
                    </div>

                    <div class="addr-field">
                        <label class="form-label">Kod</label>
                        <input class="form-input form-input--ro" th:value="${address.zipCode != null ? address.zipCode : '‚Äî'}" readonly/>
                    </div>

                    <div class="addr-field">
                        <label class="form-label">Miasto</label>
                        <input class="form-input form-input--ro" th:value="${address.city != null ? address.city : '‚Äî'}" readonly/>
                    </div>

                    <div class="addr-field">
                        <label class="form-label">Wojew√≥dztwo</label>
                        <input class="form-input form-input--ro" th:value="${address.state != null ? address.state : '‚Äî'}" readonly/>
                    </div>

                    <div class="addr-field" style="grid-column:1 / -1">
                        <label class="form-label">Kraj</label>
                        <input class="form-input form-input--ro"
                               th:value="${address.country != null && #strings.length(#strings.trim(address.country)) > 0 ? address.country : '‚Äî'}"
                               readonly/>
                    </div>
                </div>

            </div>
        </section>

        <section class="card">
            <header class="card-h">
                <div style="display:flex;flex-direction:column;gap:4px;min-width:0">
                    <h2>Sektory</h2>
                    <div style="color:rgba(255,255,255,0.65);font-size:.92rem">
                        Lista sektor√≥w przypisanych do magazynu
                    </div>
                </div>

                <div class="card-actions">
                    <button type="button" class="chip chip--filter"
                            th:disabled="${whId == 0}"
                            onclick="openSectorCreate()">
                        ‚ûï Dodaj sektor
                    </button>
                </div>
            </header>

            <div class="card-b" style="min-width:0">

                <div class="placeholder" th:if="${whId == 0}">
                    <div class="ph-title">Najpierw zapisz magazyn</div>
                    <div class="ph-sub">Sektory mo≈ºesz dodawaƒá dopiero po zapisaniu magazynu.</div>
                </div>

                <div class="table-wrap" th:if="${whId != 0}" style="min-width:0">
                    <table class="table">
                        <thead>
                        <tr>
                            <th>Kod</th>
                            <th>Nazwa</th>
                            <th>Typ</th>
                            <th style="width:220px">Akcje</th>
                        </tr>
                        </thead>
                        <tbody>

                        <tr th:if="${sectors == null || #lists.isEmpty(sectors)}">
                            <td colspan="4">
                                <div class="placeholder" style="margin:6px 0">
                                    <div class="ph-title">Brak sektor√≥w</div>
                                    <div class="ph-sub">Dodaj sektor przyciskiem ‚ÄûDodaj sektor‚Äù.</div>
                                </div>
                            </td>
                        </tr>

                        <tr th:each="s : ${sectors}">
                            <td class="mono" th:text="${s.code}">S-01</td>
                            <td th:text="${s.name}">Sk≈Çadowanie</td>
                            <td>
                                <span th:class="${'tag ' + (s.type == T(edu.uws.ii.springboot.enums.SectorTypeEnum).LoadingHub ? 'tag--loadingHub' : (s.type == T(edu.uws.ii.springboot.enums.SectorTypeEnum).UnloadingHub ? 'tag--unloadingHub' : 'tag--sector'))}"
                                      th:text="${s.type != null ? s.type.description : '‚Äî'}">‚Äî</span>
                            </td>
                            <td>
                                <div style="display:flex;gap:10px;flex-wrap:wrap">
                                    <button type="button"
                                            class="chip chip--muted chip--sm"
                                            onclick="openSectorEdit(this)"
                                            th:attr="data-id=${s.id},data-code=${s.code},data-name=${s.name},data-type=${s.type != null ? s.type : ''}">
                                        ‚úèÔ∏è Edytuj
                                    </button>

                                    <a class="chip chip--danger chip--sm"
                                       th:href="@{/Warehouses/DeleteSector(warehouseId=${whId}, id=${s.id})}"
                                       onclick="return confirm('UsunƒÖƒá sektor?')">
                                        üóë Usu≈Ñ
                                    </a>
                                </div>
                            </td>
                        </tr>

                        </tbody>
                    </table>
                </div>
            </div>
        </section>

        <section class="card">
            <header class="card-h">
                <div style="display:flex;flex-direction:column;gap:4px;min-width:0">
                    <h2>
                        Przypisani pracownicy
                        <span class="badge" th:text="${employees != null ? #lists.size(employees) : 0}">0</span>
                    </h2>
                    <div style="color:rgba(255,255,255,0.65);font-size:.92rem">
                        Osoby przypiƒôte do tego magazynu
                    </div>
                </div>

                <div class="card-actions">
                    <button type="button"
                            class="chip chip--filter"
                            onclick="openEmployeeModal()"
                            th:disabled="${whId == 0}">
                        ‚ûï Przypisz pracownika
                    </button>
                </div>
            </header>

            <div class="card-b" style="min-width:0">

                <div class="placeholder" th:if="${whId == 0}">
                    <div class="ph-title">Najpierw zapisz magazyn</div>
                    <div class="ph-sub">Pracownik√≥w mo≈ºesz przypinaƒá dopiero po zapisaniu magazynu.</div>
                </div>

                <div class="table-wrap" th:if="${whId != 0}" style="min-width:0">
                    <table class="table table--fixed">
                        <colgroup>
                            <col style="width:32%">
                            <col style="width:36%">
                            <col style="width:16%">
                            <col style="width:220px">
                        </colgroup>

                        <thead>
                        <tr>
                            <th>Pracownik</th>
                            <th>Email</th>
                            <th>Telefon</th>
                            <th>Akcje</th>
                        </tr>
                        </thead>

                        <tbody>
                        <tr th:if="${employees == null || #lists.isEmpty(employees)}">
                            <td colspan="4">
                                <div class="placeholder" style="margin:6px 0">
                                    <div class="ph-title">Brak pracownik√≥w</div>
                                    <div class="ph-sub">Kliknij ‚ÄûPrzypisz pracownika‚Äù, aby kogo≈õ dodaƒá.</div>
                                </div>
                            </td>
                        </tr>

                        <tr th:each="e : ${employees}">
                            <td style="min-width:0">
                                <div class="cell-main">
                                    <div class="main-title"
                                         th:text="${(e.firstName != null ? e.firstName : '') + ' ' + (e.lastName != null ? e.lastName : '')}">
                                        Jan Kowalski
                                    </div>
                                    <div class="main-sub mono" th:text="${'#' + e.id}">#1</div>
                                </div>
                            </td>

                            <td class="mono td-clip" th:text="${e.email != null ? e.email : '‚Äî'}">a@b.com</td>
                            <td class="td-clip"
                                th:text="${e.phone != null && #strings.length(#strings.trim(e.phone)) > 0 ? e.phone : '‚Äî'}">‚Äî</td>

                            <td>
                                <a class="chip chip--danger chip--sm"
                                   th:href="@{/Warehouses/UnassignEmployee(warehouseId=${whId}, employeeId=${e.id})}"
                                   onclick="return confirm('OdpiƒÖƒá pracownika od magazynu?')">
                                    ‚õìÔ∏è‚Äçüí• Odepnij
                                </a>
                            </td>
                        </tr>
                        </tbody>
                    </table>
                </div>

            </div>
        </section>

    </div>

    <div class="modal" id="sectorModal" aria-hidden="true">
        <div class="modal__backdrop" onclick="closeModal('sectorModal')"></div>

        <div class="modal__dialog" role="dialog" aria-modal="true">
            <div class="modal__head">
                <div class="modal__title" id="sectorModalTitle">Sektor</div>
                <button type="button" class="chip chip--muted chip--sm" onclick="closeModal('sectorModal')">‚úñ</button>
            </div>

            <form id="sectorForm"
                  th:action="@{/Warehouses/UpsertSector}"
                  method="post"
                  class="modal__body"
                  onsubmit="return lockSubmit(this)">

                <input type="hidden" name="warehouseId" th:value="${whId}"/>
                <input type="hidden" name="id" id="sectorId"/>

                <div class="field">
                    <label class="form-label">Kod</label>
                    <input class="form-input mono" name="code" id="sectorCode" placeholder="np. S-01" required/>
                </div>

                <div class="field">
                    <label class="form-label">Nazwa</label>
                    <input class="form-input" name="name" id="sectorName" placeholder="np. Sk≈Çadowanie" required/>
                </div>

                <div class="modal__actions">
                    <button type="button" class="chip chip--muted" onclick="closeModal('sectorModal')">Anuluj</button>
                    <button type="submit" class="chip chip--save">üíæ Zapisz sektor</button>
                </div>
            </form>
        </div>
    </div>

    <div class="modal" id="employeeModal" aria-hidden="true">
        <div class="modal__backdrop" onclick="closeModal('employeeModal')"></div>

        <div class="modal__dialog modal__dialog--tall"
             role="dialog"
             aria-modal="true"
             aria-labelledby="employeeModalTitle">

            <div class="modal__head">
                <div class="modal__title" id="employeeModalTitle" style="display:flex;gap:10px;align-items:center;min-width:0">
                    Przypisz pracownika
                    <span class="badge" th:text="${avail != null ? #lists.size(avail) : 0}">0</span>
                </div>
                <button type="button" class="chip chip--muted chip--sm" onclick="closeModal('employeeModal')">‚úñ</button>
            </div>

            <div class="modal__body modal__body--flex" style="min-width:0">

                <div class="field">
                    <label class="form-label">Szukaj</label>
                    <input class="form-input" id="empQuery"
                           placeholder="Imiƒô / nazwisko / email..."
                           oninput="filterEmployeesPick()"/>
                    <div class="form-hint" style="color:rgba(255,255,255,.65)">
                        widocznych: <span class="mono" id="empVisibleCount">0</span>
                    </div>
                </div>

                <div class="switch-row">
                    <span style="color:rgba(255,255,255,.85)">Poka≈º ju≈º przypisanych</span>
                    <input id="empShowAssigned" type="checkbox" onchange="filterEmployeesPick()"/>
                </div>

                <div id="empList" class="pick-list pick-list--scroll">

                    <div class="placeholder" th:if="${avail == null || #lists.isEmpty(avail)}">
                        <div class="ph-title">Brak dostƒôpnych pracownik√≥w</div>
                        <div class="ph-sub">Nie ma kogo przypisaƒá (albo filtr roli nie zwraca wynik√≥w).</div>
                    </div>

                    <div th:if="${avail != null && !#lists.isEmpty(avail)}"
                         th:each="e : ${avail}"
                         class="pick-item"
                         th:with="assigned=${assignedIds != null && e.id != null && #sets.contains(assignedIds, e.id)}"
                         th:attr="
                            data-assigned=${assigned ? '1' : '0'},
                            data-search=${#strings.toLowerCase((e.firstName != null ? e.firstName : '') + ' ' + (e.lastName != null ? e.lastName : '') + ' ' + (e.email != null ? e.email : ''))}
                         ">

                        <div class="pick-main" style="min-width:0">
                            <div class="pick-title"
                                 th:text="${(e.firstName != null ? e.firstName : '') + ' ' + (e.lastName != null ? e.lastName : '')}">
                                Jan Kowalski
                            </div>
                            <div class="pick-sub mono td-clip"
                                 th:text="${e.email != null ? e.email : '‚Äî'}">a@b.com</div>
                        </div>

                        <div th:if="${assigned}">
                            <span class="tag tag--sector">Ju≈º przypisany</span>
                        </div>

                        <a th:if="${!assigned}"
                           class="chip chip--save chip--sm"
                           th:href="@{/Warehouses/AssignEmployee(warehouseId=${whId}, employeeId=${e.id})}"
                           onclick="return onAssignEmployee(this)">
                            ‚ûï Przypisz
                        </a>
                    </div>

                </div>

                <div class="modal__actions modal__actions--sticky">
                    <button type="button" class="chip chip--muted" onclick="clearEmployeeFilter()">üßπ Wyczy≈õƒá filtr</button>
                    <button type="button" class="chip chip--muted" onclick="closeModal('employeeModal')">Zamknij</button>
                </div>

            </div>
        </div>
    </div>

    <script th:inline="javascript">
        // Guard: je≈õli fragment jest renderowany ponownie (np. po redirectach / partialach), nie duplikuj definicji
        if (!window.__warehouseEditFormInit) {
          window.__warehouseEditFormInit = true;

          window.qs = function(sel, root = document){ return root.querySelector(sel); };
          window.qsa = function(sel, root = document){ return Array.from(root.querySelectorAll(sel)); };

          window.openModal = function(id){
            const m = document.getElementById(id);
            if (!m) return;
            m.classList.add('open');
            m.setAttribute('aria-hidden', 'false');
          };

          window.closeModal = function(id){
            const m = document.getElementById(id);
            if (!m) return;
            m.classList.remove('open');
            m.setAttribute('aria-hidden', 'true');
          };

          document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
              window.closeModal('sectorModal');
              window.closeModal('employeeModal');
            }
          });

          window.lockSubmit = function(form){
            try {
              const btn = window.qs('button[type="submit"]', form);
              if (btn) {
                btn.disabled = true;
                btn.textContent = '‚è≥ Zapisujƒô...';
              }
            } catch (e) {}
            return true;
          };

          // ===== SEKTORY =====
          window.openSectorCreate = function(){
            const WAREHOUSE_ID = Number(/*[[${whId}]]*/ 0);
            if (!WAREHOUSE_ID || WAREHOUSE_ID <= 0) {
              alert('Najpierw zapisz magazyn, ≈ºeby dodawaƒá sektory.');
              return;
            }
            const title = document.getElementById('sectorModalTitle');
            if (title) title.textContent = 'Dodaj sektor';

            const idEl = document.getElementById('sectorId');
            const codeEl = document.getElementById('sectorCode');
            const nameEl = document.getElementById('sectorName');
            const typeSel = document.getElementById('sectorType');

            if (idEl) idEl.value = '';
            if (codeEl) codeEl.value = '';
            if (nameEl) nameEl.value = '';
            if (typeSel) typeSel.value = 'Normal';

            window.openModal('sectorModal');
          };

          window.openSectorEdit = function(btn){
            const title = document.getElementById('sectorModalTitle');
            if (title) title.textContent = 'Edytuj sektor';

            const id   = btn?.getAttribute('data-id') || '';
            const code = btn?.getAttribute('data-code') || '';
            const name = btn?.getAttribute('data-name') || '';
            const type = btn?.getAttribute('data-type') || '';

            const idEl = document.getElementById('sectorId');
            const codeEl = document.getElementById('sectorCode');
            const nameEl = document.getElementById('sectorName');
            const typeSel = document.getElementById('sectorType');

            if (idEl) idEl.value = id;
            if (codeEl) codeEl.value = code;
            if (nameEl) nameEl.value = name;
            if (typeSel && type) typeSel.value = type;

            window.openModal('sectorModal');
          };

          window.openEmployeeModal = function(){
            const WAREHOUSE_ID = Number(/*[[${whId}]]*/ 0);
            if (!WAREHOUSE_ID || WAREHOUSE_ID <= 0) {
              alert('Najpierw zapisz magazyn, ≈ºeby przypisywaƒá pracownik√≥w.');
              return;
            }

            const q = document.getElementById('empQuery');
            if (q) q.value = '';

            const show = document.getElementById('empShowAssigned');
            if (show) show.checked = false;

            window.openModal('employeeModal');
            window.filterEmployeesPick();
          };

          window.clearEmployeeFilter = function(){
            const q = document.getElementById('empQuery');
            if (q) q.value = '';
            const show = document.getElementById('empShowAssigned');
            if (show) show.checked = false;
            window.filterEmployeesPick();
          };

          window.filterEmployeesPick = function(){
            const query = (document.getElementById('empQuery')?.value || '').trim().toLowerCase();
            const showAssigned = !!document.getElementById('empShowAssigned')?.checked;

            const list = document.getElementById('empList');
            if (!list) return;

            const items = window.qsa('.pick-item', list);
            let visible = 0;

            for (const el of items) {
              const s = (el.getAttribute('data-search') || '');
              const assigned = (el.getAttribute('data-assigned') || '0') === '1';

              const okQuery = !query || s.includes(query);
              const okAssigned = showAssigned || !assigned;

              const ok = okQuery && okAssigned;
              el.style.display = ok ? '' : 'none';
              if (ok) visible++;
            }

            const cnt = document.getElementById('empVisibleCount');
            if (cnt) cnt.textContent = String(visible);

            const existing = window.qs('.placeholder.__dyn', list);
            if (existing) existing.remove();

            if (items.length > 0 && visible === 0) {
              const ph = document.createElement('div');
              ph.className = 'placeholder __dyn';
              ph.innerHTML = `
                <div class="ph-title">Brak wynik√≥w</div>
                <div class="ph-sub">Zmie≈Ñ frazƒô lub w≈ÇƒÖcz ‚ÄûPoka≈º ju≈º przypisanych‚Äù.</div>
              `;
              list.prepend(ph);
            }
          };

          window.onAssignEmployee = function(a){
            if (!confirm('Przypisaƒá pracownika do magazynu?')) return false;
            try {
              a.classList.add('is-busy');
              a.textContent = '‚è≥ Przypisujƒô...';
              a.style.pointerEvents = 'none';
            } catch (e) {}
            return true;
          };
        }
    </script>

</div>
