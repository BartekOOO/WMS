<div th:fragment="fragment" xmlns:th="http://www.thymeleaf.org">

    <div id="top"></div>

    <section class="card">
        <header class="card-h">
            <div style="display:flex;align-items:center;gap:10px;min-width:0;flex-wrap:wrap">
                <h2 style="margin:0">Produkt</h2>

                <span class="tag tag--danger"
                      th:if="${product != null and (product.archival or product.isArchival)}">
                    Archiwalny
                </span>

                <span class="tag tag--ok"
                      th:if="${product != null and !(product.archival or product.isArchival)}">
                    Aktywny
                </span>

                <div style="color:rgba(255,255,255,0.65);font-size:.92rem;margin-left:6px">
                    Tryb: edycja
                </div>
            </div>

            <div class="card-actions">
                <a class="chip" th:href="@{/Products/GetProducts(isArchival=false)}">WrÃ³Ä‡</a>
            </div>
        </header>

        <div class="card-b">

            <div class="alert-glass alert-glass--success" th:if="${success != null}">
                <div class="alert-glass__icon">âœ“</div>
                <div class="alert-glass__content">
                    <div class="alert-glass__title">Sukces</div>
                    <div class="alert-glass__msg" th:text="${success}">Operacja zakoÅ„czona powodzeniem.</div>
                </div>
            </div>

            <div class="alert-glass alert-glass--danger" th:if="${error != null}">
                <div class="alert-glass__icon">!</div>
                <div class="alert-glass__content">
                    <div class="alert-glass__title">Nie udaÅ‚o siÄ™ wykonaÄ‡ operacji</div>
                    <div class="alert-glass__msg" th:text="${error}">WystÄ…piÅ‚ bÅ‚Ä…d.</div>
                </div>
            </div>

            <div class="alert-glass alert-glass--danger"
                 th:if="${product != null && (product.archival or product.isArchival)}">
                <div class="alert-glass__icon">â›”</div>
                <div class="alert-glass__content">
                    <div class="alert-glass__title">Produkt archiwalny</div>
                    <div class="alert-glass__msg">
                        Edycja produktu jest zablokowana. Jednostki i cechy rÃ³wnieÅ¼.
                    </div>
                </div>
            </div>

            <form th:object="${command}"
                  th:action="@{/Products/EditProduct}"
                  method="post"
                  enctype="multipart/form-data"
                  style="display:grid;gap:14px"
                  onsubmit="markScrollTopOnce()">

                <input type="hidden" th:field="*{id}"/>

                <div style="display:grid;grid-template-columns:1.2fr .8fr;gap:12px">

                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;align-content:start">

                        <div>
                            <label class="form-label">SKU</label>
                            <input class="form-input mono"
                                   th:field="*{sku}"
                                   placeholder="np. SKU-001"
                                   th:disabled="${product != null && (product.archival or product.isArchival)}"/>
                            <div class="form-err" th:if="${#fields.hasErrors('sku')}" th:errors="*{sku}"></div>
                        </div>

                        <div>
                            <label class="form-label">Jednostka podstawowa</label>
                            <input class="form-input mono"
                                   th:field="*{unit}"
                                   placeholder="np. szt, kg, m"
                                   th:disabled="${product != null && (product.archival or product.isArchival)}"/>
                            <div class="form-err" th:if="${#fields.hasErrors('unit')}" th:errors="*{unit}"></div>
                        </div>

                        <div style="grid-column:1/-1">
                            <label class="form-label">Nazwa</label>
                            <input class="form-input"
                                   th:field="*{name}"
                                   placeholder="PeÅ‚na nazwa produktu"
                                   th:disabled="${product != null && (product.archival or product.isArchival)}"/>
                            <div class="form-err" th:if="${#fields.hasErrors('name')}" th:errors="*{name}"></div>
                        </div>

                        <div>
                            <label class="form-label">EAN</label>
                            <input class="form-input mono"
                                   th:field="*{ean}"
                                   placeholder="np. 590..."
                                   th:disabled="${product != null && (product.archival or product.isArchival)}"/>
                            <div class="form-err" th:if="${#fields.hasErrors('ean')}" th:errors="*{ean}"></div>
                        </div>

                        <div>
                            <label class="form-label">Marka</label>
                            <input class="form-input"
                                   th:field="*{brand}"
                                   placeholder="np. Bosch"
                                   th:disabled="${product != null && (product.archival or product.isArchival)}"/>
                            <div class="form-err" th:if="${#fields.hasErrors('brand')}" th:errors="*{brand}"></div>
                        </div>

                        <div style="grid-column:1/-1">
                            <label class="form-label">Opis</label>
                            <textarea class="form-input"
                                      th:field="*{description}"
                                      style="min-height:140px;resize:vertical"
                                      placeholder="Opis produktu (opcjonalnie)"
                                      th:disabled="${product != null && (product.archival or product.isArchival)}"></textarea>
                            <div class="form-err" th:if="${#fields.hasErrors('description')}" th:errors="*{description}"></div>
                        </div>

                        <div style="grid-column:1/-1">
                            <label class="form-label">Data dodania</label>
                            <input class="form-input mono" type="text" readonly
                                   th:value="${
                                        product != null && product.createdAt != null
                                        ? T(java.time.format.DateTimeFormatter).ofPattern('yyyy-MM-dd HH:mm').format(product.createdAt)
                                        : 'â€”'
                                   }"/>
                            <div class="form-hint">Tylko podglÄ…d.</div>
                        </div>

                    </div>

                    <section class="card product-photo-card"
                             style="box-shadow:none;border:1px solid rgba(255,255,255,0.10);background:rgba(255,255,255,0.03)">
                        <header class="card-h" style="border-bottom:1px solid rgba(255,255,255,0.08)">
                            <h2 style="font-size:1.05rem">ZdjÄ™cie</h2>
                        </header>

                        <div class="card-b">
                            <div class="photo-box">

                                <div class="photo-current"
                                     th:if="${product != null && product.photoContent != null && product.photoContent.length > 0}">
                                    <img class="photo-preview"
                                         th:src="@{/Products/Photo(id=${product.id}, v=${product.id})}"
                                         alt="Aktualne zdjÄ™cie"/>
                                    <div class="photo-meta">
                                        <div class="mono" th:text="${product.photoName != null ? product.photoName : 'foto'}">foto</div>
                                        <div class="muted" th:text="${product.photoContentType != null ? product.photoContentType : 'image/*'}">image/*</div>
                                    </div>
                                </div>

                                <div th:if="${product == null || product.photoContent == null || product.photoContent.length == 0}"
                                     class="photo-placeholder">
                                    ðŸ“· Brak zdjÄ™cia
                                </div>

                                <label class="chip"
                                       style="justify-self:start;cursor:pointer"
                                       th:styleappend="${product != null && (product.archival or product.isArchival)} ? 'opacity:.55;cursor:not-allowed' : ''">
                                    ZmieÅ„ zdjÄ™cie
                                    <input type="file" name="photo" accept="image/*"
                                           style="display:none"
                                           onchange="previewPhotoEdit(event)"
                                           th:disabled="${product != null && (product.archival or product.isArchival)}"/>
                                </label>

                                <img id="photoPreviewEdit"
                                     class="photo-preview"
                                     style="display:none;margin-top:10px"
                                     alt="PodglÄ…d nowego zdjÄ™cia"/>

                                <div class="form-hint">Po zapisie zdjÄ™cie zostanie nadpisane.</div>
                            </div>
                        </div>
                    </section>

                </div>

                <div class="form-actions">
                    <a class="chip chip--danger"
                       th:if="${product != null && product.id != null && !(product.archival or product.isArchival)}"
                       th:href="@{/Products/DeleteProduct(id=${product.id})}"
                       onclick="return confirm('Na pewno archiwizowaÄ‡ produkt?');">
                        ðŸ—‘ Archiwizuj
                    </a>

                    <span class="chip chip--muted"
                          th:if="${product != null && (product.archival or product.isArchival)}"
                          style="opacity:.9;cursor:default">
                        Produkt archiwalny â€” edycja zablokowana
                    </span>

                    <button class="chip chip--save"
                            type="submit"
                            th:disabled="${product != null && (product.archival or product.isArchival)}"
                            th:styleappend="${product != null && (product.archival or product.isArchival)} ? 'opacity:.55;cursor:not-allowed' : ''">
                        ðŸ’¾ Zapisz zmiany
                    </button>
                </div>
            </form>

            <div style="height:18px"></div>

            <section id="units">
                <div style="display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:10px">
                    <div style="font-weight:900">Jednostki</div>

                    <button type="button"
                            class="chip"
                            onclick="openModal('unitAdd')"
                            th:disabled="${product != null && (product.archival or product.isArchival)}"
                            th:styleappend="${product != null && (product.archival or product.isArchival)} ? 'opacity:.55;cursor:not-allowed' : ''">
                        + Dodaj jednostkÄ™
                    </button>
                </div>

                <div class="table-wrap">
                    <table class="table units-table">
                        <thead>
                        <tr>
                            <th>Nazwa</th>
                            <th class="mono">Przelicznik</th>
                            <th>Przeliczenie</th>
                            <th style="text-align:right">Akcje</th>
                        </tr>
                        </thead>

                        <tbody>
                        <tr th:each="u : ${product != null ? product.units : null}"
                            th:with="
                                baseUnit=${product != null ? product.unit : 'JM'},
                                auxUnit=${u.unitName},
                                n=${u.multiplier},
                                inv=${
                                    n != null && n.compareTo(T(java.math.BigDecimal).ZERO) > 0
                                    ? T(java.math.BigDecimal).ONE.divide(n, 8, T(java.math.RoundingMode).HALF_UP)
                                    : null
                                },
                                nTxt=${n != null ? #strings.replace(n.stripTrailingZeros().toPlainString(), '.', ',') : 'â€”'},
                                invTxt=${inv != null ? #strings.replace(inv.stripTrailingZeros().toPlainString(), '.', ',') : 'â€”'}
                            ">

                            <td th:text="${auxUnit}">opak</td>

                            <td class="mono" th:text="${nTxt}">12</td>

                            <td>
                                <div class="unit-eq mono">
                                    <div class="unit-eq__line">
                                        1x <span th:text="${auxUnit}">opak</span>
                                        =
                                        <span th:text="${nTxt}">12</span>x
                                        <span th:text="${baseUnit}">szt</span>
                                    </div>

                                    <div class="unit-eq__sub">
                                        1x <span th:text="${baseUnit}">szt</span>
                                        =
                                        <span th:text="${invTxt}">0,0833</span>x
                                        <span th:text="${auxUnit}">opak</span>
                                    </div>
                                </div>
                            </td>

                            <td style="text-align:right;white-space:nowrap">
                                <button type="button"
                                        class="chip"
                                        onclick="openUnitEdit(this)"
                                        th:attr="data-id=${u.id},
                                            data-name=${auxUnit},
                                            data-mult=${nTxt}"
                                        th:disabled="${product != null && (product.archival or product.isArchival)}"
                                        th:styleappend="${product != null && (product.archival or product.isArchival)} ? 'opacity:.55;cursor:not-allowed' : ''">
                                    Edytuj
                                </button>

                                <a class="chip"
                                   th:href="@{/Products/DeleteUnit(productId=${product.id}, id=${u.id})}"
                                   onclick="markScrollTopOnce(); return confirm('UsunÄ…Ä‡ jednostkÄ™?')"
                                   th:if="${product != null && !(product.archival or product.isArchival)}">
                                    UsuÅ„
                                </a>

                                <span class="chip chip--muted"
                                      th:if="${product != null && (product.archival or product.isArchival)}"
                                      style="opacity:.65;cursor:default">
                                    UsuÅ„
                                </span>
                            </td>
                        </tr>

                        <tr th:if="${product == null || product.units == null || #lists.isEmpty(product.units)}">
                            <td colspan="4" style="padding:16px;color:rgba(255,255,255,0.65)">
                                Brak jednostek.
                            </td>
                        </tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <div style="height:18px"></div>

            <section id="props">
                <div style="display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:10px">
                    <div style="font-weight:900">Cechy</div>

                    <button type="button"
                            class="chip"
                            onclick="openModal('propAdd')"
                            th:disabled="${product != null && (product.archival or product.isArchival)}"
                            th:styleappend="${product != null && (product.archival or product.isArchival)} ? 'opacity:.55;cursor:not-allowed' : ''">
                        + Dodaj cechÄ™
                    </button>
                </div>

                <div class="table-wrap">
                    <table class="table props-table">
                        <thead>
                        <tr>
                            <th>Nazwa cechy</th>
                            <th style="text-align:right">Akcje</th>
                        </tr>
                        </thead>

                        <tbody>
                        <tr th:each="pr : ${product != null ? product.properties : null}">
                            <td th:text="${pr.propertyName}">kolor</td>

                            <td style="text-align:right;white-space:nowrap">
                                <button type="button"
                                        class="chip"
                                        onclick="openPropEdit(this)"
                                        th:attr="data-id=${pr.id},data-name=${pr.propertyName}"
                                        th:disabled="${product != null && (product.archival or product.isArchival)}"
                                        th:styleappend="${product != null && (product.archival or product.isArchival)} ? 'opacity:.55;cursor:not-allowed' : ''">
                                    Edytuj
                                </button>

                                <a class="chip"
                                   th:href="@{/Products/DeleteProperty(productId=${product.id}, id=${pr.id})}"
                                   onclick="markScrollTopOnce(); return confirm('UsunÄ…Ä‡ cechÄ™?')"
                                   th:if="${product != null && !(product.archival or product.isArchival)}">
                                    UsuÅ„
                                </a>

                                <span class="chip chip--muted"
                                      th:if="${product != null && (product.archival or product.isArchival)}"
                                      style="opacity:.65;cursor:default">
                                    UsuÅ„
                                </span>
                            </td>
                        </tr>

                        <tr th:if="${product == null || product.properties == null || #lists.isEmpty(product.properties)}">
                            <td colspan="2" style="padding:16px;color:rgba(255,255,255,0.65)">
                                Brak cech.
                            </td>
                        </tr>
                        </tbody>
                    </table>
                </div>
            </section>

        </div>
    </section>

    <div class="modal" id="unitAdd">
        <div class="modal__backdrop" onclick="closeModal('unitAdd')"></div>
        <div class="modal__dialog">
            <div class="modal__head">
                <div class="modal__title">Dodaj jednostkÄ™</div>
                <button type="button" class="chip chip--muted" onclick="closeModal('unitAdd')">âœ•</button>
            </div>

            <form method="post"
                  th:action="@{/Products/RegisterUnit}"
                  class="modal__body"
                  onsubmit="return validateUnitForm('unitAddMult');">

                <input type="hidden" name="productId" th:value="${product != null ? product.id : 0}"/>

                <div class="field">
                    <label class="form-label">Nazwa</label>
                    <input class="form-input"
                           name="unitName"
                           placeholder="np. pudeÅ‚ko / karton / paleta"
                           required/>
                </div>

                <div class="field">
                    <label class="form-label">Przelicznik</label>
                    <input class="form-input mono"
                           id="unitAddMult"
                           name="multiplier"
                           placeholder="np. 12 lub 10000"
                           value="1"
                           inputmode="decimal"
                           required/>
                    <div class="form-hint">Ile <b>jednostek podstawowych</b> mieÅ›ci siÄ™ w <b>1 jednostce pomocniczej</b>. Akceptuje kropkÄ™ i przecinek.</div>
                    <div class="form-err" id="unitAddMultErr" style="display:none"></div>
                </div>

                <div class="modal__actions">
                    <button type="button" class="chip chip--muted" onclick="closeModal('unitAdd')">Anuluj</button>
                    <button type="submit" class="chip chip--save" onclick="markScrollTopOnce()">Dodaj</button>
                </div>
            </form>
        </div>
    </div>

    <div class="modal" id="unitEdit">
        <div class="modal__backdrop" onclick="closeModal('unitEdit')"></div>
        <div class="modal__dialog">
            <div class="modal__head">
                <div class="modal__title">Edytuj jednostkÄ™</div>
                <button type="button" class="chip chip--muted" onclick="closeModal('unitEdit')">âœ•</button>
            </div>

            <form method="post"
                  th:action="@{/Products/EditUnit}"
                  class="modal__body"
                  onsubmit="return validateUnitForm('unitEditMult');">

                <input type="hidden" name="productId" th:value="${product != null ? product.id : 0}"/>
                <input type="hidden" name="id" id="unitEditId"/>

                <div class="field">
                    <label class="form-label">Nazwa</label>
                    <input class="form-input" name="unitName" id="unitEditName" required/>
                </div>

                <div class="field">
                    <label class="form-label">Przelicznik</label>
                    <input class="form-input mono"
                           name="multiplier"
                           id="unitEditMult"
                           inputmode="decimal"
                           required/>
                    <div class="form-hint">Ile jednostek podstawowych mieÅ›ci siÄ™ w 1 jednostce pomocniczej.</div>
                    <div class="form-err" id="unitEditMultErr" style="display:none"></div>
                </div>

                <div class="modal__actions">
                    <button type="button" class="chip chip--muted" onclick="closeModal('unitEdit')">Anuluj</button>
                    <button type="submit" class="chip chip--save" onclick="markScrollTopOnce()">Zapisz</button>
                </div>
            </form>
        </div>
    </div>

    <div class="modal" id="propAdd">
        <div class="modal__backdrop" onclick="closeModal('propAdd')"></div>
        <div class="modal__dialog">
            <div class="modal__head">
                <div class="modal__title">Dodaj cechÄ™</div>
                <button type="button" class="chip chip--muted" onclick="closeModal('propAdd')">âœ•</button>
            </div>

            <form method="post"
                  th:action="@{/Products/RegisterProperty}"
                  class="modal__body"
                  onsubmit="markScrollTopOnce()">

                <input type="hidden" name="productId" th:value="${product != null ? product.id : 0}"/>

                <div class="field">
                    <label class="form-label">Nazwa cechy</label>
                    <input class="form-input" name="propertyName" placeholder="np. kolor / rozmiar / wariant" required/>
                </div>

                <div class="modal__actions">
                    <button type="button" class="chip chip--muted" onclick="closeModal('propAdd')">Anuluj</button>
                    <button type="submit" class="chip chip--save">Dodaj</button>
                </div>
            </form>
        </div>
    </div>

    <div class="modal" id="propEdit">
        <div class="modal__backdrop" onclick="closeModal('propEdit')"></div>
        <div class="modal__dialog">
            <div class="modal__head">
                <div class="modal__title">Edytuj cechÄ™</div>
                <button type="button" class="chip chip--muted" onclick="closeModal('propEdit')">âœ•</button>
            </div>

            <form method="post"
                  th:action="@{/Products/EditProperty}"
                  class="modal__body"
                  onsubmit="markScrollTopOnce()">

                <input type="hidden" name="productId" th:value="${product != null ? product.id : 0}"/>
                <input type="hidden" name="id" id="propEditId"/>

                <div class="field">
                    <label class="form-label">Nazwa cechy</label>
                    <input class="form-input" name="propertyName" id="propEditName" required/>
                </div>

                <div class="modal__actions">
                    <button type="button" class="chip chip--muted" onclick="closeModal('propEdit')">Anuluj</button>
                    <button type="submit" class="chip chip--save">Zapisz</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // ---------- scroll to top after redirect ----------
        function markScrollTopOnce() {
            try { localStorage.setItem('scrollTopOnce', '1'); } catch(e) {}
        }
        (function restoreScrollTopOnce(){
            try {
                if (localStorage.getItem('scrollTopOnce') === '1') {
                    localStorage.removeItem('scrollTopOnce');
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                }
            } catch(e) {}
        })();

        // ---------- photo preview ----------
        function previewPhotoEdit(e) {
            const file = e.target.files && e.target.files[0];
            const img = document.getElementById('photoPreviewEdit');
            if (!file) { img.style.display='none'; return; }
            img.src = URL.createObjectURL(file);
            img.style.display = 'block';
        }

        // ---------- modal ----------
        function openModal(id){
            const m = document.getElementById(id);
            if(!m) return;
            m.classList.add('open');
        }
        function closeModal(id){
            const m = document.getElementById(id);
            if(!m) return;
            m.classList.remove('open');
        }

        // ---------- unit edit fill ----------
        function openUnitEdit(btn){
            const id = btn.getAttribute('data-id');
            const name = btn.getAttribute('data-name');
            const mult = btn.getAttribute('data-mult');

            document.getElementById('unitEditId').value = id || '';
            document.getElementById('unitEditName').value = name || '';
            document.getElementById('unitEditMult').value = (mult || '1').toString();

            const err = document.getElementById('unitEditMultErr');
            if (err) { err.style.display = 'none'; err.textContent = ''; }

            openModal('unitEdit');
        }

        function openPropEdit(btn){
            const id = btn.getAttribute('data-id');
            const name = btn.getAttribute('data-name');

            document.getElementById('propEditId').value = id || '';
            document.getElementById('propEditName').value = name || '';

            openModal('propEdit');
        }

        // ---------- multiplier validation ----------
        function normalizeDecimal(s){
            if (s == null) return '';
            return ('' + s).trim().replace(/\s+/g,'').replace(',', '.');
        }

        function validateUnitForm(multInputId){
            const inp = document.getElementById(multInputId);
            if(!inp) return true;

            const raw = inp.value;
            const norm = normalizeDecimal(raw);
            inp.value = norm;

            const n = Number(norm);
            const errEl = document.getElementById(multInputId + 'Err');
            const showErr = (msg) => {
                if (errEl) {
                    errEl.textContent = msg;
                    errEl.style.display = 'block';
                } else {
                    alert(msg);
                }
            };

            if (!norm) { showErr('Podaj przelicznik.'); return false; }
            if (!isFinite(n) || isNaN(n)) { showErr('Przelicznik musi byÄ‡ liczbÄ… (np. 12 lub 0.5).'); return false; }
            if (n <= 0) { showErr('Przelicznik musi byÄ‡ wiÄ™kszy od 0.'); return false; }

            if (errEl) { errEl.style.display = 'none'; errEl.textContent = ''; }

            markScrollTopOnce();
            return true;
        }
    </script>
</div>
